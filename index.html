<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Physics Labs: Mass & Inertia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* --- Shared & Tab Styles --- */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@500&display=swap');
        
        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Default to Mass Lab bg */
            transition: background-color 0.3s;
        }

        /* Tab Navigation */
        .nav-tabs {
            background: white;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: center;
            padding: 0.5rem;
            position: sticky;
            top: 0;
            z-index: 50;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .tab-btn {
            padding: 0.5rem 1.5rem;
            margin: 0 0.5rem;
            border-radius: 999px;
            font-weight: 600;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .tab-btn:hover {
            background-color: #f1f5f9;
            color: #334155;
        }
        .tab-btn.active {
            background-color: #e0e7ff; /* Indigo-100 */
            color: #4f46e5; /* Indigo-600 */
            border-color: #c7d2fe;
        }
        
        /* View Container */
        .view-section {
            display: none;
            width: 100%;
        }
        .view-section.active {
            display: block;
        }

        /* --- APP 1: MASS LAB STYLES --- */
        .lab-font {
            font-family: 'JetBrains Mono', monospace;
        }
        .draggable-item {
            cursor: grab;
            transition: transform 0.2s, box-shadow 0.2s;
            user-select: none;
        }
        .draggable-item:active {
            cursor: grabbing;
            transform: scale(0.95);
        }
        .obj-iron {
            background: linear-gradient(135deg, #475569 0%, #1e293b 100%);
            border: 2px solid #0f172a;
            color: white;
        }
        .obj-wood {
            background: #d97706;
            background-image: repeating-linear-gradient(45deg, transparent, transparent 5px, rgba(0,0,0,0.1) 5px, rgba(0,0,0,0.1) 10px);
            border: 2px solid #78350f;
            color: white;
        }
        .obj-gold {
            background: linear-gradient(135deg, #fcd34d 0%, #b45309 100%);
            border: 2px solid #78350f;
            color: #451a03;
        }
        .obj-balloon {
            background: radial-gradient(circle at 30% 30%, #38bdf8, #0284c7);
            border: 2px solid #0369a1;
            color: white;
            box-shadow: inset -5px -5px 10px rgba(0,0,0,0.1);
        }
        .obj-brick {
            background-color: #b91c1c;
            background-image: 
                linear-gradient(335deg, rgba(0,0,0,0.2) 23px, transparent 23px),
                linear-gradient(155deg, rgba(0,0,0,0.2) 23px, transparent 23px),
                linear-gradient(335deg, rgba(0,0,0,0.2) 23px, transparent 23px),
                linear-gradient(155deg, rgba(0,0,0,0.2) 23px, transparent 23px);
            background-size: 58px 58px;
            background-position: 0px 2px, 4px 35px, 29px 31px, 34px 6px;
            border: 2px solid #7f1d1d;
            color: white;
        }
        .obj-styrofoam {
            background: #f8fafc;
            border: 2px solid #cbd5e1;
            background-image: radial-gradient(#e2e8f0 15%, transparent 16%), radial-gradient(#e2e8f0 15%, transparent 16%);
            background-size: 10px 10px;
            color: #475569;
        }
        .obj-lead {
            background: #334155;
            border: 2px solid #020617;
            color: #94a3b8;
        }
        .obj-apple {
            background: radial-gradient(circle at 30% 30%, #ef4444, #991b1b);
            border-radius: 40% 40% 50% 50% / 35% 35% 50% 50%;
            border: 1px solid #7f1d1d;
            position: relative;
        }
        .obj-apple::before {
            content: '';
            position: absolute;
            top: -4px;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 8px;
            background: #3f2e05;
            border-radius: 2px;
        }
        .scale-plate {
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .scale-active {
            transform: translateY(8px);
        }
        .led-screen {
            background: #0f172a;
            box-shadow: inset 0 0 15px rgba(0,0,0,0.8);
            border: 4px solid #334155;
        }
        .led-text-green {
            color: #4ade80;
            text-shadow: 0 0 10px rgba(74, 222, 128, 0.6);
        }

        /* --- APP 2: INERTIA SIM STYLES --- */
        /* Specific overrides for the Inertia section */
        #inertia-app canvas {
            display: block;
            width: 100%;
            height: 60vh;
            background-color: #e0f2fe;
        }
        #inertia-app .controls {
            height: 40vh;
            background: #fff;
            border-top: 4px solid #3b82f6;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        #inertia-app .btn-group {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
            justify-content: center;
        }
        #inertia-app .btn {
            padding: 0.8rem 1.2rem;
            font-size: 1rem;
            font-weight: bold;
            border-radius: 0.5rem;
            transition: all 0.1s;
            cursor: pointer;
            border: none;
            color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 5px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        #inertia-app .btn:active { transform: scale(0.95); box-shadow: none; }
        #inertia-app .btn-accel { background-color: #22c55e; }
        #inertia-app .btn-brake { background-color: #ef4444; }
        #inertia-app .btn-sudden { background-color: #000; color: #fbbf24; border: 2px solid #fbbf24; }
        #inertia-app .btn-cruise { background-color: #3b82f6; }
        #inertia-app .btn-reset { background-color: #6b7280; }
        #inertia-app .btn-seatbelt { background-color: #a855f7; }
        #inertia-app .btn-seatbelt-on { background-color: #7e22ce; border: 2px solid #d8b4fe; }
        
        #inertia-app .concept-tag {
            background: #f3f4f6;
            padding: 0.3rem 0.8rem;
            border-radius: 999px;
            font-size: 0.9rem;
            font-weight: bold;
            color: #4b5563;
            margin-top: 0.3rem;
            display: inline-block;
            font-family: 'Segoe UI', sans-serif;
        }
        #inertia-app #status-area { text-align: center; margin-bottom: 0.5rem; }
    </style>
</head>
<body>

    <!-- Tab Navigation -->
    <nav class="nav-tabs">
        <button class="tab-btn active" onclick="switchTab('mass')">
            <i class="fas fa-balance-scale mr-2"></i>Mass Lab
        </button>
        <button class="tab-btn" onclick="switchTab('inertia')">
            <i class="fas fa-bus mr-2"></i>Inertia Sim
        </button>
    </nav>

    <!-- ========================================== -->
    <!-- APP 1: MASS LAB CONTENT -->
    <!-- ========================================== -->
    <div id="mass-app" class="view-section active">
        <!-- Header -->
        <header class="bg-white shadow-sm p-4">
            <div class="max-w-6xl mx-auto flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="bg-indigo-600 text-white p-2 rounded-lg shadow-lg">
                        <i class="fas fa-balance-scale fa-lg"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-slate-900">Mass Lab</h1>
                        <p class="text-xs text-slate-500 font-medium">Add objects to measure total mass</p>
                    </div>
                </div>
                <button onclick="clearScale()" class="bg-slate-100 hover:bg-slate-200 text-slate-600 text-sm font-semibold py-2 px-4 rounded-lg transition-colors border border-slate-300">
                    <i class="fas fa-rotate-left mr-2"></i>Reset
                </button>
            </div>
        </header>

        <main class="flex-grow p-4 md:p-8 flex flex-col items-center gap-8 max-w-6xl mx-auto w-full">
            <div class="flex flex-col lg:flex-row gap-8 w-full items-start justify-center">
                
                <!-- SHELF (Object Library) -->
                <div class="w-full lg:w-1/3 bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden flex flex-col h-[550px]">
                    <div class="bg-slate-50 p-4 border-b border-slate-200">
                        <h2 class="font-bold text-slate-700 flex items-center gap-2">
                            <i class="fas fa-cubes text-indigo-500"></i> Object Shelf
                        </h2>
                        <p class="text-xs text-slate-500 mt-1">Drag items to the scale on the right</p>
                    </div>
                    
                    <div class="p-4 grid grid-cols-2 gap-4 overflow-y-auto custom-scroll flex-grow content-start">
                        <!-- Balloon -->
                        <div class="draggable-item flex flex-col items-center gap-1 p-2 bg-slate-50 rounded-lg border border-slate-100 hover:border-indigo-200" 
                             draggable="true" 
                             ondragstart="drag(event)" 
                             onclick="clickToAdd('balloon', 0.05, 70, 'obj-balloon')"
                             data-type="balloon" data-mass="0.05" data-size="70" data-style="obj-balloon">
                            <div class="obj-balloon w-16 h-16 rounded-full shadow-md flex items-center justify-center font-bold text-xs">He</div>
                            <div class="text-center">
                                <div class="text-xs font-bold text-slate-700">Balloon</div>
                                <div class="text-[10px] text-slate-500">0.05 kg</div>
                            </div>
                        </div>
                        <!-- Styrofoam -->
                        <div class="draggable-item flex flex-col items-center gap-1 p-2 bg-slate-50 rounded-lg border border-slate-100 hover:border-indigo-200" 
                             draggable="true" 
                             ondragstart="drag(event)" 
                             onclick="clickToAdd('styrofoam', 0.1, 80, 'obj-styrofoam')"
                             data-type="styrofoam" data-mass="0.1" data-size="80" data-style="obj-styrofoam">
                            <div class="obj-styrofoam w-20 h-20 rounded shadow-md flex items-center justify-center font-bold text-xs">Foam</div>
                            <div class="text-center">
                                <div class="text-xs font-bold text-slate-700">Styrofoam</div>
                                <div class="text-[10px] text-slate-500">0.10 kg</div>
                            </div>
                        </div>
                        <!-- Apple -->
                        <div class="draggable-item flex flex-col items-center gap-1 p-2 bg-slate-50 rounded-lg border border-slate-100 hover:border-indigo-200" 
                             draggable="true" 
                             ondragstart="drag(event)" 
                             onclick="clickToAdd('apple', 0.2, 45, 'obj-apple')"
                             data-type="apple" data-mass="0.2" data-size="45" data-style="obj-apple">
                            <div class="obj-apple w-10 h-10 shadow-md flex items-center justify-center text-white text-[9px] pt-1"></div>
                            <div class="text-center">
                                <div class="text-xs font-bold text-slate-700">Apple</div>
                                <div class="text-[10px] text-slate-500">0.20 kg</div>
                            </div>
                        </div>
                        <!-- Wood -->
                        <div class="draggable-item flex flex-col items-center gap-1 p-2 bg-slate-50 rounded-lg border border-slate-100 hover:border-indigo-200" 
                             draggable="true" 
                             ondragstart="drag(event)" 
                             onclick="clickToAdd('wood', 2, 60, 'obj-wood')"
                             data-type="wood" data-mass="2" data-size="60" data-style="obj-wood">
                            <div class="obj-wood w-14 h-14 rounded shadow-md flex items-center justify-center font-bold text-xs">Wood</div>
                            <div class="text-center">
                                <div class="text-xs font-bold text-slate-700">Wood</div>
                                <div class="text-[10px] text-slate-500">2.00 kg</div>
                            </div>
                        </div>
                        <!-- Brick -->
                        <div class="draggable-item flex flex-col items-center gap-1 p-2 bg-slate-50 rounded-lg border border-slate-100 hover:border-indigo-200" 
                             draggable="true" 
                             ondragstart="drag(event)" 
                             onclick="clickToAdd('brick', 3, 55, 'obj-brick')"
                             data-type="brick" data-mass="3" data-size="55" data-style="obj-brick">
                            <div class="obj-brick w-14 h-10 rounded shadow-md flex items-center justify-center font-bold text-xs">Brick</div>
                            <div class="text-center">
                                <div class="text-xs font-bold text-slate-700">Brick</div>
                                <div class="text-[10px] text-slate-500">3.00 kg</div>
                            </div>
                        </div>
                        <!-- Iron -->
                        <div class="draggable-item flex flex-col items-center gap-1 p-2 bg-slate-50 rounded-lg border border-slate-100 hover:border-indigo-200" 
                             draggable="true" 
                             ondragstart="drag(event)" 
                             onclick="clickToAdd('iron', 5, 45, 'obj-iron')"
                             data-type="iron" data-mass="5" data-size="45" data-style="obj-iron">
                            <div class="obj-iron w-10 h-10 rounded shadow-md flex items-center justify-center font-bold text-xs">Fe</div>
                            <div class="text-center">
                                <div class="text-xs font-bold text-slate-700">Iron</div>
                                <div class="text-[10px] text-slate-500">5.00 kg</div>
                            </div>
                        </div>
                         <!-- Gold -->
                         <div class="draggable-item flex flex-col items-center gap-1 p-2 bg-slate-50 rounded-lg border border-slate-100 hover:border-indigo-200" 
                             draggable="true" 
                             ondragstart="drag(event)" 
                             onclick="clickToAdd('gold', 10, 40, 'obj-gold')"
                             data-type="gold" data-mass="10" data-size="40" data-style="obj-gold">
                            <div class="obj-gold w-10 h-10 rounded shadow-md flex items-center justify-center font-bold text-xs">Au</div>
                            <div class="text-center">
                                <div class="text-xs font-bold text-slate-700">Gold</div>
                                <div class="text-[10px] text-slate-500">10.00 kg</div>
                            </div>
                        </div>
                        <!-- Lead -->
                        <div class="draggable-item flex flex-col items-center gap-1 p-2 bg-slate-50 rounded-lg border border-slate-100 hover:border-indigo-200" 
                             draggable="true" 
                             ondragstart="drag(event)" 
                             onclick="clickToAdd('lead', 20, 35, 'obj-lead')"
                             data-type="lead" data-mass="20" data-size="35" data-style="obj-lead">
                            <div class="obj-lead w-8 h-8 rounded shadow-md flex items-center justify-center font-bold text-xs border-2 border-slate-900">Pb</div>
                            <div class="text-center">
                                <div class="text-xs font-bold text-slate-700">Lead</div>
                                <div class="text-[10px] text-slate-500">20.00 kg</div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- THE MACHINE -->
                <div class="w-full lg:w-2/3 flex flex-col items-center justify-center lg:mt-10">
                    
                    <!-- Weighing Area -->
                    <div class="relative w-full max-w-md" style="height: 350px;">
                        
                        <!-- Drop Zone (The Pan) -->
                        <div id="dropZone" 
                             ondrop="drop(event)" 
                             ondragover="allowDrop(event)" 
                             class="absolute bottom-0 left-1/2 transform -translate-x-1/2 w-80 h-48 border-4 border-dashed border-slate-300 rounded-xl flex items-end justify-center flex-wrap content-end p-2 gap-1 bg-white/50 transition-colors z-20 hover:border-indigo-400 hover:bg-indigo-50/30">
                            
                            <div class="pointer-events-none absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-center select-none" id="drop-hint">
                                <i class="fas fa-arrow-down text-3xl text-slate-300 mb-2"></i>
                                <div class="text-slate-300 font-bold text-lg">DROP HERE</div>
                            </div>
                        </div>
                        <!-- Scale Graphic Structure -->
                        <div class="absolute bottom-[-20px] left-1/2 transform -translate-x-1/2 w-72 h-4 bg-slate-400 rounded scale-plate" id="plate"></div>
                        <div class="absolute bottom-[-60px] left-1/2 transform -translate-x-1/2 w-10 h-40 bg-slate-300 -z-10"></div>
                    </div>
                    <!-- Digital Readout Base -->
                    <div class="mt-8 w-full max-w-md bg-slate-800 rounded-lg shadow-2xl p-8 relative z-30">
                        
                        <div class="flex justify-between items-center mb-6 border-b border-slate-700 pb-2">
                            <div class="text-slate-400 text-xs font-bold uppercase tracking-wider">Digital Mass Meter</div>
                            <div class="w-2 h-2 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.8)]"></div>
                        </div>
                        <!-- Large Mass Display -->
                        <div class="led-screen rounded p-6 text-center relative overflow-hidden group">
                            <div class="text-xs text-slate-500 uppercase mb-2">Total Mass</div>
                            <div class="flex items-baseline justify-center gap-2">
                                <div class="lab-font led-text-green text-6xl font-bold tracking-widest" id="massVal">0.00</div>
                                <div class="text-xl text-green-700 font-bold">kg</div>
                            </div>
                            <div class="absolute inset-0 bg-green-500/5 pointer-events-none"></div>
                            <div class="absolute inset-0 bg-[linear-gradient(rgba(18,16,16,0)_50%,rgba(0,0,0,0.25)_50%),linear-gradient(90deg,rgba(255,0,0,0.06),rgba(0,255,0,0.02),rgba(0,0,255,0.06))] bg-[length:100%_4px,6px_100%] pointer-events-none opacity-20"></div>
                        </div>
                        <div class="mt-4 text-center">
                            <p class="text-[10px] text-slate-500">
                                * Click objects on the pan to remove them.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- ========================================== -->
    <!-- APP 2: INERTIA SIM CONTENT -->
    <!-- ========================================== -->
    <div id="inertia-app" class="view-section">
        <canvas id="simCanvas"></canvas>
        <div class="controls">
            <div id="status-area">
                <h2 id="statusText" class="text-xl font-bold text-gray-800">State: Stopped</h2>
                <div id="physicsConcept" class="concept-tag">Newton's First Law</div>
                <div class="mt-1 text-sm text-gray-600 leading-tight" id="explanation">Click Accelerate to start. Toggle seatbelts to see the difference.</div>
            </div>
            <div class="btn-group">
                <button class="btn btn-brake" onmousedown="applyBrake()" onmouseup="releaseControls()" ontouchstart="applyBrake()" ontouchend="releaseControls()">
                    BRAKE  üõë
                </button>
                <button class="btn btn-cruise" onclick="setCruise()">
                    CRUISE  üöå
                </button>
                <button class="btn btn-accel" onmousedown="applyGas()" onmouseup="releaseControls()" ontouchstart="applyGas()" ontouchend="releaseControls()">
                    ACCEL  üöÄ
                </button>
            </div>
            
            <div class="btn-group">
                 <button id="btn-seatbelt" class="btn btn-seatbelt" onclick="toggleSeatbelts()">
                    SEATBELTS OFF  üîì
                </button>
                 <button class="btn btn-sudden" onclick="triggerSuddenBrake()">
                     ‚ö†Ô∏è  SUDDEN BRAKE  ‚ö†Ô∏è
                </button>
                <button class="btn btn-reset" onclick="resetSim()">
                    RESET  üîÑ
                </button>
            </div>
        </div>
    </div>

    <script>
        // === GLOBAL TAB LOGIC ===
        function switchTab(tab) {
            // Hide all
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            
            // Show selected
            if(tab === 'mass') {
                document.getElementById('mass-app').classList.add('active');
                document.querySelectorAll('.tab-btn')[0].classList.add('active');
                document.body.style.backgroundColor = '#f0f4f8';
                document.body.style.overflow = 'auto';
            } else {
                document.getElementById('inertia-app').classList.add('active');
                document.querySelectorAll('.tab-btn')[1].classList.add('active');
                document.body.style.backgroundColor = '#e0f2fe';
                document.body.style.overflow = 'hidden';
                // Trigger canvas resize to ensure it renders correctly after being hidden
                resize();
            }
        }

        // ==========================================
        // APP 1: MASS LAB LOGIC
        // ==========================================
        const dropZone = document.getElementById('dropZone');
        const massDisplay = document.getElementById('massVal');
        const dropHint = document.getElementById('drop-hint');
        const plate = document.getElementById('plate');

        function allowDrop(ev) {
            ev.preventDefault();
            dropZone.classList.add('border-indigo-400', 'bg-indigo-50/30');
        }

        function drag(ev) {
            const data = {
                mass: parseFloat(ev.target.dataset.mass),
                size: ev.target.dataset.size,
                style: ev.target.dataset.style,
                type: ev.target.dataset.type
            };
            ev.dataTransfer.setData("application/json", JSON.stringify(data));
        }

        function drop(ev) {
            ev.preventDefault();
            dropZone.classList.remove('border-indigo-400', 'bg-indigo-50/30');
            const rawData = ev.dataTransfer.getData("application/json");
            if(rawData) {
                const data = JSON.parse(rawData);
                addObjectToScale(data);
            }
        }

        function clickToAdd(type, mass, size, style) {
            const data = { type, mass, size, style };
            addObjectToScale(data);
        }

        function addObjectToScale(data) {
            const el = document.createElement('div');
            el.className = `${data.style} rounded shadow-lg cursor-pointer hover:scale-105 transition-transform relative flex items-center justify-center`;
            el.style.width = `${data.size}px`; 
            el.style.height = `${data.type === 'brick' ? data.size * 0.6 : data.size}px`;
            
            if(data.type === 'balloon') el.style.borderRadius = '50%';
            
            el.dataset.mass = data.mass;
            el.title = "Click to remove";
            
            el.onclick = function() {
                el.style.transform = "scale(0)";
                setTimeout(() => {
                    if(dropZone.contains(el)) dropZone.removeChild(el);
                    updateReadout();
                }, 200);
            };
            const label = document.createElement('span');
            label.innerText = data.mass + 'kg';
            label.className = "text-[10px] font-bold opacity-0 hover:opacity-100 transition-opacity bg-black/50 text-white px-1 rounded pointer-events-none absolute";
            el.appendChild(label);
            dropZone.appendChild(el);
            
            animateScaleDown();
            updateReadout();
        }

        function updateReadout() {
            let totalMass = 0;
            Array.from(dropZone.children).forEach(child => {
                if (child.dataset.mass) {
                    totalMass += parseFloat(child.dataset.mass);
                }
            });
            if (totalMass > 0 || dropZone.querySelectorAll('[data-mass]').length > 0) {
                dropHint.style.display = 'none';
            } else {
                dropHint.style.display = 'block';
            }
            massDisplay.innerText = totalMass.toFixed(2);
        }

        function clearScale() {
            const items = dropZone.querySelectorAll('[data-mass]');
            items.forEach(item => item.remove());
            updateReadout();
        }

        function animateScaleDown() {
            plate.classList.add('scale-active');
            setTimeout(() => {
                plate.classList.remove('scale-active');
            }, 150);
        }
        
        if(dropZone) {
            dropZone.addEventListener('dragleave', () => {
                 dropZone.classList.remove('border-indigo-400', 'bg-indigo-50/30');
            });
        }

        // ==========================================
        // APP 2: INERTIA SIM LOGIC
        // ==========================================
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');
        
        let busSpeed = 0;
        let busAccel = 0;
        const maxSpeed = 25;
        
        let passengerLean = 0;
        let roadOffset = 0;
        let cloudOffset = 0;
        let controlState = 'idle';
        let glassBroken = false;
        let seatbeltsActive = false;
        
        let passengers = [];
        function initPassengers() {
            passengers = [
                { id: 1, type: 'sit', xRel: 45, yRel: 80, seatbeltOn: seatbeltsActive, isFlying: false, vx: 0, vy: 0, angle: 0, grounded: false },
                { id: 2, type: 'stand', xRel: 110, yRel: 80, seatbeltOn: false, isFlying: false, vx: 0, vy: 0, angle: 0, grounded: false },
                { id: 3, type: 'sit', xRel: 175, yRel: 80, seatbeltOn: seatbeltsActive, isFlying: false, vx: 0, vy: 0, angle: 0, grounded: false },
                { id: 4, type: 'stand', xRel: 240, yRel: 80, seatbeltOn: false, isFlying: false, vx: 0, vy: 0, angle: 0, grounded: false }
            ];
        }
        initPassengers();

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight * 0.6;
        }
        window.addEventListener('resize', resize);
        // Initial resize happens on load, or when tab switches

        function applyGas() {
            if(controlState === 'sudden_brake') return;
            controlState = 'accelerating';
            updateUI('Accelerating', 'Inertia of Rest', 'Body resists motion, leaning backward.');
        }
        function applyBrake() {
            if(controlState === 'sudden_brake') return;
            controlState = 'braking';
            updateUI('Braking', 'Inertia of Motion', 'Body resists stopping, leaning forward.');
        }
        function setCruise() {
            if(controlState === 'sudden_brake') return;
            controlState = 'cruising';
            updateUI('Cruising', 'Equilibrium', 'Constant velocity. Passengers upright.');
        }
        function releaseControls() {
            if(controlState !== 'cruising' && controlState !== 'sudden_brake') {
                 controlState = 'coasting';
                 updateUI('Coasting', 'Friction', 'Gradually slowing down.');
            }
        }
        function toggleSeatbelts() {
            if(controlState === 'sudden_brake') return;
            seatbeltsActive = !seatbeltsActive;
            const btn = document.getElementById('btn-seatbelt');
            if(seatbeltsActive) {
                btn.classList.add('btn-seatbelt-on');
                btn.innerHTML = 'SEATBELTS ON  üîí ';
            } else {
                btn.classList.remove('btn-seatbelt-on');
                btn.innerHTML = 'SEATBELTS OFF  üîì ';
            }
            passengers.forEach(p => {
                if(p.type === 'sit') p.seatbeltOn = seatbeltsActive;
            });
        }
        
        function triggerSuddenBrake() {
            if(busSpeed < 5) { alert("Move faster first!"); return; }
            if(controlState === 'sudden_brake') return;
            controlState = 'sudden_brake';
            glassBroken = false;
            passengers.forEach(p => {
                p.initializedEjection = false;
                if (!p.seatbeltOn || p.type === 'stand') {
                    p.isFlying = true;
                    p.vx = busSpeed * 0.6;
                    p.vy = -3 - Math.random() * 2;
                    glassBroken = true;
                } else {
                    p.isFlying = false;
                }
            });
            let msg = glassBroken ? 'Unbelted passengers ejected!' : 'Seatbelts saved everyone!';
            updateUI('CRASH!', 'Inertia & External Force', `Bus stopped instantly. ${msg}`);
        }

        function resetSim() {
            busSpeed = 0;
            busAccel = 0;
            controlState = 'idle';
            glassBroken = false;
            passengerLean = 0;
            initPassengers();
            updateUI('Stopped', 'Ready', 'Click Accelerate. Try seatbelts!');
        }

        function updateUI(status, concept, desc) {
            document.getElementById('statusText').innerText = `State: ${status}`;
            document.getElementById('physicsConcept').innerText = concept;
            document.getElementById('explanation').innerText = desc;
        }

        function drawScene() {
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#87CEEB'); gradient.addColorStop(1, '#E0F7FA');
            ctx.fillStyle = gradient; ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
            if(controlState !== 'sudden_brake') cloudOffset -= busSpeed * 0.2; 
            if (cloudOffset < -200) cloudOffset = 0;
            [100, 400, 800].forEach(x => {
                let cx = x + cloudOffset; while(cx < -100) cx += canvas.width + 200;
                ctx.beginPath(); ctx.arc(cx, 60, 40, 0, Math.PI*2);
                ctx.arc(cx+30, 60, 50, 0, Math.PI*2); ctx.fill();
            });
            
            const roadY = canvas.height - 50;
            ctx.fillStyle = '#4a4a4a'; ctx.fillRect(0, roadY, canvas.width, 50);
            
            ctx.strokeStyle = '#fff'; ctx.lineWidth = 10;
            ctx.setLineDash([40, 40]);
            if(controlState !== 'sudden_brake') roadOffset += busSpeed;
            ctx.lineDashOffset = -roadOffset;
            ctx.beginPath(); ctx.moveTo(0, roadY + 25); ctx.lineTo(canvas.width, roadY + 25);
            ctx.stroke(); ctx.setLineDash([]);
        }

        function drawBus() {
            const busX = canvas.width / 2 - 150;
            const busY = canvas.height - 200;
            const busW = 300; const busH = 160;
            ctx.fillStyle = '#FBBF24'; ctx.strokeStyle = '#D97706'; ctx.lineWidth = 4;
            ctx.beginPath(); ctx.roundRect(busX, busY, busW, busH, 20); ctx.fill(); ctx.stroke();
            const windowW = 50; const startX = busX + 20;
            for(let i=0; i<4; i++) {
                if(glassBroken && i === 3) {
                     ctx.fillStyle = '#000';
                     ctx.beginPath(); ctx.moveTo(startX+(i*65), busY+20);
                     ctx.lineTo(startX+(i*65)+windowW, busY+50); ctx.lineTo(startX+(i*65), busY+80); ctx.fill();
                } else {
                     ctx.fillStyle = '#bfdbfe';
                     ctx.fillRect(startX + (i * 65), busY + 20, windowW, 60);
                     ctx.strokeRect(startX + (i * 65), busY + 20, windowW, 60);
                }
            }
            drawWheel(busX + 60, busY + busH, 25);
            drawWheel(busX + busW - 60, busY + busH, 25);
            passengers.forEach(p => {
                if(p.isFlying) {
                    drawPassengerEjected(p);
                } else {
                    drawPassengerAttached(p, busX + p.xRel, busY + 80, p.type === 'stand');
                }
            });
        }

        function drawWheel(x, y, r) {
            ctx.save(); ctx.translate(x, y);
            if(controlState !== 'sudden_brake') ctx.rotate(roadOffset * 0.05);
            ctx.beginPath(); ctx.arc(0, 0, r, 0, Math.PI * 2); ctx.fillStyle = '#1f2937'; ctx.fill();
            ctx.fillStyle = '#9ca3af'; ctx.beginPath(); ctx.arc(0, 0, r * 0.6, 0, Math.PI * 2); ctx.fill();
            ctx.strokeStyle = '#4b5563'; ctx.lineWidth = 3; ctx.beginPath();
            ctx.moveTo(-r*0.6, 0); ctx.lineTo(r*0.6, 0); ctx.moveTo(0, -r*0.6); ctx.lineTo(0, r*0.6); ctx.stroke();
            ctx.restore();
        }

        function drawPassengerAttached(p, x, y, isStanding) {
            ctx.save(); ctx.translate(x, y);
            const leanRad = (passengerLean * Math.PI) / 180;
            if (isStanding) {
                ctx.save(); ctx.translate(0, -60); ctx.rotate(-leanRad * 1.5);
                ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(0, 40);
                ctx.lineWidth = 3; ctx.strokeStyle = '#374151'; ctx.stroke();
                ctx.beginPath(); ctx.arc(0, 45, 5, 0, Math.PI*2); ctx.stroke(); ctx.restore();
            }
            ctx.beginPath(); ctx.strokeStyle = '#1e3a8a'; ctx.lineWidth = 6;
            if(isStanding) { ctx.moveTo(0, 0); ctx.lineTo(0, 40); } 
            else { ctx.moveTo(0, 0); ctx.lineTo(0, 20); ctx.lineTo(15, 20); }
            ctx.stroke();
            ctx.translate(0, 0); ctx.rotate(-leanRad);
            
            ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(0, -35);
            ctx.strokeStyle = '#dc2626'; ctx.lineWidth = 8; ctx.stroke();
            
            if(p.seatbeltOn && !isStanding) {
                ctx.beginPath(); ctx.moveTo(-5, -35); ctx.lineTo(5, 0);
                ctx.strokeStyle = '#333'; ctx.lineWidth = 4; ctx.stroke();
            }
            
            ctx.beginPath(); ctx.arc(0, -45, 10, 0, Math.PI * 2); ctx.fillStyle = '#fca5a5'; ctx.fill();
            
            ctx.beginPath(); ctx.moveTo(0, -25);
            if(isStanding) ctx.lineTo(10, -50); else ctx.lineTo(15, -15);
            ctx.strokeStyle = '#fca5a5'; ctx.lineWidth = 4; ctx.stroke();
            ctx.restore();
        }

        function drawPassengerEjected(p) {
            const busCenterX = canvas.width / 2 - 150;
            if (!p.initializedEjection) {
                 const busY = canvas.height - 200; p.yRel = busY + 80; p.xRel = p.xRel; p.initializedEjection = true;
            }
            const drawX = busCenterX + p.xRel;
            ctx.save(); ctx.translate(drawX, p.yRel); ctx.rotate(p.angle);
            ctx.strokeStyle = '#dc2626'; ctx.lineWidth = 8;
            ctx.beginPath(); ctx.moveTo(-10, 0); ctx.lineTo(10, 0); ctx.stroke();
            ctx.fillStyle = '#fca5a5'; ctx.beginPath(); ctx.arc(15, 0, 10, 0, Math.PI*2); ctx.fill();
            ctx.strokeStyle = '#1e3a8a'; ctx.beginPath(); ctx.moveTo(-10, 0); ctx.lineTo(-20, 10); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(-10, 0); ctx.lineTo(-20, -10); ctx.stroke();
            ctx.restore();
        }

        function loop() {
            // Only draw if inertia app is visible to save resources, though not strictly required
            if(document.getElementById('inertia-app').classList.contains('active')) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                if(controlState === 'sudden_brake') {
                    busSpeed = 0; busAccel = 0;
                    passengerLean = 45;
                    passengers.forEach(p => {
                        if(p.isFlying && !p.grounded) {
                            p.xRel += p.vx; p.yRel += p.vy;
                            p.vy += 0.25;
                            p.angle += 0.05;
                            if(p.yRel > canvas.height - 60) {
                                p.yRel = canvas.height - 60; p.vy = -p.vy * 0.6; p.vx *= 0.8;
                                if(Math.abs(p.vx) < 0.5 && Math.abs(p.vy) < 0.5) p.grounded = true;
                            }
                        }
                    });
                } else {
                    if (controlState === 'accelerating') busAccel = 0.2;
                    else if (controlState === 'braking') busAccel = -0.3;
                    else if (controlState === 'coasting') busAccel = (busSpeed > 0) ? -0.05 : 0;
                    else if (controlState === 'cruising') { busAccel = 0; if(busSpeed < 10) busSpeed += 0.1; }
                    busSpeed += busAccel; if (busSpeed < 0) busSpeed = 0; if (busSpeed > maxSpeed) busSpeed = maxSpeed;
                    let targetLean = busAccel * 40; passengerLean += (targetLean - passengerLean) * 0.1;
                }
                drawScene(); drawBus();
                
                ctx.fillStyle = 'rgba(0,0,0,0.6)'; ctx.fillRect(10, 10, 160, 60);
                ctx.fillStyle = '#fff'; ctx.font = '14px monospace';
                ctx.fillText(`Speed: ${Math.floor(busSpeed * 10)} km/h`, 20, 30);
                if(controlState === 'sudden_brake') { ctx.fillStyle = '#ef4444'; ctx.fillText(`STATUS: CRASH`, 20, 50); } 
                else { ctx.fillText(`Accel: ${busAccel.toFixed(2)}`, 20, 50); }
            }
            requestAnimationFrame(loop);
        }
        
        // Start the loop
        loop();
        // Initial resize
        resize();
    </script>
</body>
</html>
